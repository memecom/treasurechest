<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <link
      href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/nes.icons@latest/css/nes-icons.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");
    </style>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
      type="application/javascript"
    ></script>
  </head>
  <title>Welcome to Vue</title>

  <body>
    <div id="app">
      <div id="navbar">
        <!-- Navbar -->
        <button id="connect-wallet" class="nes-btn is-normal" @click="signIn">
          {{ !account ? 'Connect to wallet' : humanizeWallet(account) }}
        </button>
        <span v-if="account" id="key-info">üóùÔ∏è {{ keys }}</span>
      </div>
      <div id="main">
        <!-- Main -->
        <img src="https://vuejs.org/images/logo.png" alt="Vue logo" />
        <h1>{{ greeting }}</h1>
        <div id="app-dialog">
          <div id="nft-list-section">
            <img v-for="image in contractImages" :src="image" />          
          </div>
          <div id="nft-unlock-section" v-if="account">
            <button
              id="unlock-nft"
              class="nes-btn is-primary"
              @click="randomNFT"
            >
              <span>üîê My Random NFT</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      var app = new Vue({
        el: "#app",
        data: {
          greeting: "",
          account: "",
          network: "",
          keys: 0,
          vaultAddress: "0x6CCEaC1D31cF8BB217f26d2CFd56d7E083815F67",
          whiteListedAddress: ["0x994de75b8089739088d679ba0b31c5167a4fa1e3"],
          keysAddress: "0x366212776F4A2623ae935b0eBE5af6b067D105C6",
          provider: null,
          keyContract: null,
          contractImages: [],
        },
        methods: {
          humanizeURL: function (url) {
            return url.replace(/^https?:\/\//, "").replace(/\/$/, "");
          },
          humanizeWallet: function (account) {
            return `${account.substr(0, 5)}...${account.substr(-3)}`;
          },
          signIn: async function (event) {
            console.log("sign in");
            if (window.ethereum) {
              this.provider = new ethers.providers.Web3Provider(
                window.ethereum
              );
              await this.provider.send("eth_requestAccounts", []);
              const signer = this.provider.getSigner();
              this.account = await signer.getAddress();
              this.getKeyContractBalance(this.provider, this.account);
              try {
                if (window.ethereum.networkVersion == "80001") {
                  this.greeting = "";
                } else {
                  this.greeting = "change network to matic testnet";
                }
              } catch (error) {
                console.log(error);
              }
            } else {
              this.greeting = "No web3? You should consider trying MetaMask!";
            }
          },
          getKeyContractBalance: async function () {
            console.log("get keys");
            const keysAbi = [
              // Some details about the token
              "function name() view returns (string)",
              "function symbol() view returns (string)",

              // Get the account balance
              "function balanceOf(address) view returns (uint)",

              // Send some of your tokens to someone else
              "function transfer(address to, uint amount)",

              // Approve to spend your tokens
              "function approve(address spender, uint amount)",

              "function increaseAllowance(address spender, uint addedValue)",

              // An event triggered whenever anyone transfers to someone else
              "event Transfer(address indexed from, address indexed to, uint amount)",
            ];
            this.keyContract = new ethers.Contract(
              this.keysAddress,
              keysAbi,
              this.provider
            );
            this.keys = await this.keyContract.balanceOf(this.account);
            this.keys = ethers.utils.formatUnits(this.keys, 18) / 1;
          },
          randomNFT: async function () {
            // approve
            // increase allowance
            // receive token
            const vaultAbi = ["function receiveToken(uint amount)"];

            const vaultContract = new ethers.Contract(
              this.vaultAddress,
              vaultAbi,
              this.provider
            );

            const signer = this.provider.getSigner();

            const tx1 = await this.keyContract
              .connect(signer)
              .approve(this.vaultAddress, "10000000000000000000");

            await tx1.wait();

            const tx2 = await this.keyContract
              .connect(signer)
              .increaseAllowance(this.vaultAddress, "10000000000000000000");

            await tx2.wait();

            const tx3 = await vaultContract
              .connect(signer)
              .receiveToken("10000000000000000000");

            await tx3.wait();

            this.keys = await this.keyContract.balanceOf(this.account);
            this.keys = ethers.utils.formatUnits(this.keys, 18);
          },
          getContractImages: async function() {
            this.contractImages = ['https://samplelib.com/lib/preview/png/sample-boat-400x300.png',
            'https://samplelib.com/lib/preview/png/sample-boat-400x300.png','https://samplelib.com/lib/preview/png/sample-boat-400x300.png'];
          }
        },
        mounted: function () {
          console.log("mounted");
          this.signIn();
          this.getContractImages();
        },
      });
    </script>

    <style>
      body {
        font-family: "Press Start 2P";
      }
      #app {
        display: flex;
        flex-direction: column;
        max-width: 72rem;
        margin: auto;
        height: 100vh;
      }
      #connect-wallet {
        width: max-content;
        align-items: flex-end;
        margin-top: 20px;
      }
      #navbar {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: flex-end;
        float: right;
        margin-top: 20px;
      }
      #main {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        margin: auto;
      }
      #key-info {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
      }
      #unlock-nft {
        font-size: 0.75rem !important;
        width: max-content;
      }
      #app-dialog {
        display: flex;
        gap: 2rem;
        position: absolute;
        float: left;
        bottom: 150px;
        height: 500px;
        width: 1000px;
      }
      #nft-list-section {
        display: grid;
        grid-template-columns: auto auto auto;
        gap: 1rem;
        flex-basis: 50%;
        border-radius: 0.75rem;
        background-color: rgb(245, 245, 245);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        padding: 20px;
      }
      #nft-list-section img {
        width: 100px;
      }
      #nft-unlock-section {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-basis: 50%;
        border-radius: 0.75rem;
        background-color: rgb(245, 245, 245);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
    </style>
  </body>
</html>
