<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <link
      href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/nes.icons@latest/css/nes-icons.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");
    </style>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
      type="application/javascript"
    ></script>
  </head>
  <title>üí∞ Unlock treasure chest</title>

  <body>
    <div id="app">
      <div id="navbar">
        <!-- Navbar -->
        <div id="navbar-container">
          <button id="connect-wallet" class="nes-btn is-disabled" @click="init">
            {{ !user.account ? 'Connect to wallet' :
            humanizeWallet(user.account) }}
          </button>
          <span v-if="user.account" id="key-info" class="nes-text is-warning">üóùÔ∏è {{ user.balance }}</span>
        </div>
      </div>
      <div id="main">
        <h1>{{ greeting }}</h1>
        <div id="app-dialog">
          <div id="nft-list-section">
              <img id="nft-img" :src="token.uri"  v-for="token in vault.tokens" />
          </div>
          <div id="nft-unlock-section" v-if="user.account">
            <button
              id="unlock-nft"
              class="nes-btn is-primary"
              v-if="!unlockstates.show"
              @click="unlocknft"
            >
              <span>üîì My Random NFT</span>
            </button>

            <div id="nft-unlockstates-section" v-if="unlockstates.show">
              <span>{{ unlockstates.approve ? '‚úÖ' : '‚¨ú' }} Approve</span>
              <span
                >{{ unlockstates.increaseAllowance ? '‚úÖ' : '‚¨ú' }} Increase
                Spending</span
              >
              <span
                >{{ unlockstates.receivetoken ? '‚úÖ' : '‚¨ú' }} Receive
                Token</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var app = new Vue({
        el: "#app",
        data: {
          greeting: "",
          provider: "",
          vault: {
            abi: "",
            address: "0x84243561d488cd758764b0848469cb9a9798fcbf",
            contract: "",
            tokens: [],
          },
          keys: {
            abi: "",
            address: "",
            contract: "",
          },
          user: {
            account: "",
            balance: 0,
          },
          unlockstates: {
            show: false,
            approve: false,
            increaseAllowance: false,
            receivetoken: false,
          },
          contracts: {},
          contractImages: [],
        },
        methods: {
          humanizeWallet: function (account) {
            return `${account.substr(0, 5)}...${account.substr(-3)}`;
          },
          imageFromIpfs: async function (uri) {
            let url = uri.replace("ipfs://", "https://ipfs.io/ipfs/");
            const response = await fetch(url);
            const data = await response.json();
            let imgurl = data.image;
            if (imgurl.includes("ipfs://"))
              imgurl = imgurl.replace("ipfs://", "https://ipfs.io/ipfs/");
            return imgurl;
          },
          fetchUserKeys: async function () {
            console.log("fetch user balance");
            this.user.balance = await this.keys.contract.balanceOf(
              this.user.account
            );
            console.log(this.user.balance);
            this.user.balance = ethers.utils.formatEther(this.user.balance) / 1;
            console.log(this.user.balance);
          },
          resetUnlockStates: function () {
            this.unlockstates = {
              show: false,
              approve: false,
              increasepending: false,
              receivetoken: false,
            };
          },
          userInit: async function () {
            // user init
            this.provider = new ethers.providers.Web3Provider(window.ethereum);
            await this.provider.send("eth_requestAccounts", []);
            const signer = this.provider.getSigner();
            this.user.account = await signer.getAddress();
          },
          vaultInit: async function () {
            // vault init
            this.vault.abi = [
              "function receiveToken(uint amount)",
              "function getNFTs() view returns (tuple(address contractAddress, uint256 tokenId, uint256 value)[] memory)",
              "function getTokenAddr() view returns (address token)",
            ];
            this.vault.contract = new ethers.Contract(
              this.vault.address,
              this.vault.abi,
              this.provider
            );
          },
          keysInit: async function () {
            //keys init
            this.keys.abi = [
              // Recieve key balance in wallet
              "function balanceOf(address) view returns (uint)",
              // Approve to spend your tokens
              "function approve(address spender, uint amount)",
              // Increase allowance after approving
              "function increaseAllowance(address spender, uint addedValue)",
            ];

            this.keys.address = await this.vault.contract.getTokenAddr();
            console.log(this.keys.address);
            this.keys.contract = new ethers.Contract(
              this.keys.address,
              this.keys.abi,
              this.provider
            );
          },
          tokensInit: async function () {
            let tokens = await this.vault.contract.getNFTs();
            this.vault.tokens = [];
            tokens.map((token) => {
              let { tokenId, value, contractAddress } = token;
              tokenId = ethers.BigNumber.from(tokenId).toString();
              value = ethers.BigNumber.from(value).toString();
              this.vault.tokens.push({
                id: tokenId,
                value,
                address: contractAddress,
                uri: "",
              });
            });

            const ERC721ABI = [
              "function tokenURI(uint256 _tokenId) view returns (string)",
            ];

            this.vault.tokens.map(async (token) => {
              if (!this.contracts[token.address]) {
                let contract = new ethers.Contract(
                  token.address,
                  ERC721ABI,
                  this.provider
                );
                this.contracts[token.address] = {};
                this.contracts[token.address] = contract;
              }
              const uri = await this.contracts[token.address].tokenURI(
                token.id
              );
              token.uri = await this.imageFromIpfs(uri);
            });
          },
          init: async function () {
            if (window.ethereum) {
              try {
                await this.userInit();
                await this.vaultInit();
                await this.keysInit();
                await this.tokensInit();
                this.fetchUserKeys();
              } catch (e) {
                console.log(e);
              }
            } else {
              console.log("no ethereum?");
              // this.greeting = "No web3? You should consider trying MetaMask!";
            }
          },
          unlocknft: async function () {
            const signer = this.provider.getSigner();

            this.unlockstates.show = true;

            try {
              const tx1 = await this.keys.contract
                .connect(signer)
                .approve(this.vault.address, "10000000000000000000");
              await tx1.wait();
              this.unlockstates.approve = true;
            } catch (e) {
              this.resetUnlockStates();
              console.log(e);
            }

            try {
              const tx2 = await this.keys.contract
                .connect(signer)
                .increaseAllowance(this.vault.address, "10000000000000000000");

              await tx2.wait();
              this.unlockstates.increaseAllowance = true;
            } catch (e) {
              this.resetUnlockStates();
              console.log(e);
            }

            try {
              const tx3 = await this.vault.contract
                .connect(signer)
                .receiveToken("10000000000000000000");

              await tx3.wait();
              this.unlockstates.receiveToken = true;
            } catch (e) {
              this.resetUnlockStates();
              console.log(e);
            }

            //sucess
            // re-initalize all tokens
            await this.tokensInit();
            // fetch current user balance
            this.fetchUserKeys();
            // reset unlock states
            this.resetUnlockStates();
          },
        },
        mounted: function () {
          console.log("mounted");
          this.init();
        },
      });
    </script>

    <style>
      body {
        font-family: "Press Start 2P";
      }
      #app {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-image: url("public/chestbg2x.png");
        background-size: cover;
      }
      #connect-wallet {
        width: max-content;
        align-items: flex-end;
        margin-top: 20px;
      }
      #navbar {
        width: 100%;
        max-width: 72rem;
        margin-top: 20px;
        margin: auto;
        margin-bottom: 20px;
      }
      #navbar-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: flex-end;
      }
      #main {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 72rem;
        margin: auto;
        margin-top: 1px;
      }
      #key-info {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
      }
      #unlock-nft {
        font-size: 0.75rem !important;
        width: max-content;
      }
      #app-dialog {
        display: flex;
        gap: 10rem;
        float: left;
        bottom: 150px;
        height: 500px;
        width: 100%;
      }
      #nft-list-section {
        display: grid;
        grid-template-columns: auto auto auto;
        gap: 1rem;
        flex-basis: 50%;
        background-color: #544b42;
        border-radius: 20px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        padding: 20px;
      }

      #nft-img {
        width: 100px;
        border-radius: 10px;
      }
      #nft #status {
        position: absolute;
        top: 30px;
        right: -70px;
        font-size: 10px;
        transform: rotate(45deg);
        background: red;
        color: white;
        width: 100%;
      }
      #nft-unlock-section {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-basis: 50%;
        border-radius: 20px;
        background-color: #544b42;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      #nft-unlockstates-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
      }
    </style>
  </body>
</html>
